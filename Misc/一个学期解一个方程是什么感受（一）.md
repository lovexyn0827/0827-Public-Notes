---
title: invokedynamic指令的个人理解
date: false
keywords: JVM, invokedynamic, ASM, 使用, 理解, lovexyn0827
desc: 试着在3000字以内讲清自己对Java 7中引入的`invokedynamic`的理解。这篇文章主要是省去了一些对Java API与JVM规范的引述，并侧重于该指令本身的使用的基本思路。如有缺漏错误之处，欢迎反馈。
id: understanding_invokedynamic:0
draft: false
---

# 一个学期解一个方程是什么感受

$$
\begin{matrix}
x'(t)=x(t)&\Longrightarrow&
	\begin{cases}\begin{matrix}
		x_1'=a_{11}x_1+a_{12}x_2+\cdots+a_{1n}x_n+f_1\\
		x_2'=a_{21}x_1+a_{22}x_2+\cdots+a_{2n}x_n+f_2\\
		x_3'=a_{31}x_1+a_{32}x_2+\cdots+a_{3n}x_n+f_3\\
		\vdots\\
		x_n'=a_{n1}x_1+a_{n2}x_2+\cdots+a_{nn}x_n+f_n\\
	\end{matrix}\end{cases}
\end{matrix}
$$

> 本文主体写作于2024年夏，经过近一年（尽管非常断断续续）的检查后，于2025.09.20暂时发布。

## 前奏

通过“注意法”，我们很容易得到微分方程$x'(t)=x(t)$的解为$x(t)=Ce^t$；也不难猜想并验证，与上述方程形似的方程$x'=kx$的解为$x=Ce^{kt}$。

emmm...貌似有点太简单了，没有意思？那我们主动地加一点点难度！
$$
x'=x+e^t\tag{1.1}
$$
疑，在方程后边随手加一个函数会怎么样呢？嗯……加了一个函数，莫非答案是$x=Ce^t+\cdots$？

唉不对不对，是我是我：
$$
x=te^t\tag{1.2}
$$
还有我们：
$$
x=(t+C)e^t\tag{1.3}
$$
等会等会，在原方程的一边加了一个东西，求解后的结果反倒像是原来的解乘上了一个东西……如果把加上的部分换成其它函数呢？
$$
x'=x+f(t)\tag{1.4}
$$
我们还是假设结果是$e^t$乘上了什么东西，于是可以猜测$x=e^tg(t)$。回代一下原方程看看呢：
$$
x'=e^t[g(t)+g'(t)]=e^tg(t)+f(t)\tag{1.5}
$$
> 等式第二段由$x=e^tg(t)$据链式法则得到，第三段由原方程$(1.5)$经代换得到

略整理一下
$$
e^tg'(t)=f(t)\tag{1.6}
$$
哦，好像有戏
$$
g'(t)=e^{-t}f(t)\tag{1.7}
$$

$$
g(t)=\int e^{-t}f(t)dt\tag{1.8}
$$

要来力
$$
x=e^tg(t)=e^t\int e^{-t}f(t)\mathrm dt\tag{1.9}
$$
好耶！

其实吧，我们也能类似地得到
$$
x'=kx+f(t)\Longrightarrow x=e^{kt}\int e^{-kt}f(t)\mathrm dt\tag{1.10}
$$
顺带一提……这个公式好像还挺漂亮的。

> 这里没有深究$e^{-kt}f(t)$的可积性，我们只单纯地假设它具有这么一个良好性质。

## 一元二阶

哦，刚才可能有一丢丢难了，放松放松，我们换一个不上去就那么“抽象”的方向转转。
$$
x''+2x'-3x=0\tag{1.11}
$$
> ——（捡起高数课本翻了翻）简单，这用特征根不就可以直接出结果嘛！
>
> ——哈呀，别不讲武德呀，为什么要用，不，为什么可以用特征根呢？

歪歪斜斜的等式间看了又看，可曾看到了那两个大字：数列！

依稀记得，“庸碌的高三”之中，我们刷过不知多少道这样的习题

> $a_{n+2}+2a_{n+1}-3a_n=0$，$a_1=a_2-1=1$，求$a_n$

那时，我们会熟练地给上面的递推公式进行移项，得到
$$
a_{n+2}-a_{n+1}=-3(a_{n+1}-a_n)\tag{1.12}
$$

$$
a_{n+2}+3a_{n+1}=a_{n+1}+3a_n\tag{1.13}
$$

然后，我们就可以构造出$\{a_{n+1}-a_n\}$和$\{a_{n+1}+3a_n\}$两个等比数列，进而很容易地求出我们想要的结果。

诶？这里的数列递推公式和我们要求解的方程长得好像哦！莫非……

你猜对了！数列可以移项，我们的微分方程又有何不可呢？
$$
x''-x'=(x'-x)'=-3(x'-x)\tag{1.14}
$$

$$
x''+3x'=(x'+3x)'=x'+3x\tag{1.15}
$$

我们构造$u=x'-x$，$v=x'+3x$，上边的方程就变成了
$$
u'=-3u\tag{1.16}
$$

$$
v'=v\tag{1.17}
$$

这个我们会：
$$
x'-x=u=C_1e^{-3t}\tag{1.18}
$$

$$
x'+3x=v=C_2e^{t}\tag{1.19}
$$

距离成功之差一步之遥喽！我们发现，上边的两个方程实际上构成了关于$x'$和$x$的二元一次方程组，我们很容易解得
$$
x=\frac14C_1e^{t}+\frac14C_2e^{-3t}\tag{1.20}
$$
别慌着这么写，这样写$C_1$和$C_2$就该汗流浃背了：我们只是来说明我们这有个可变的系数存在的，用不到这么大阵仗还再给我们个$\frac14$这个系数。所以，上边的式子也可以改写成：
$$
x=C_1e^t+C_2e^{-3t}\tag{1.21}
$$
是不是这次就和用特征根求解的一样了？

接下来再个更一般的看看：
$$
x''+px'+qx=0\tag{1.22}
$$
我们依然假设，上边的式子可以被移项成
$$
x''-\mu x'=\lambda(x'-\mu x)\tag{1.23}
$$
把这个式子与原方程统一形式
$$
x''-(\lambda+\mu)x'+\lambda\mu x=0\tag{1.24}
$$
对应系数相等
$$
\begin{cases}
-(\lambda+\mu)=p\\
\lambda\mu=q
\end{cases}\tag{1.25}
$$
进行带入消元，整理后便有
$$
\lambda^2+p\lambda+q=0\tag{1.26}
$$
特征方程出来了耶！

通常，我们可以在复数范围内解出一对不同的根$\lambda_1$、$\lambda_2$，照着前边的办法一顿操作，得到
$$
x=C_1e^{\lambda_1t}+C_2e^{\lambda_2t}\tag{1.27}
$$
正好印证了特征根法的结果。

如果万一我们解出的两个根相同呢？这样，我们就不能求解关于$x'$和$x$的方程组了（可以逝一逝），但是至少我们还能得到：
$$
x'=\mu x+C_1e^{\lambda t}\tag{1.28}
$$
而且，我们还可以证明，这时候我们解得的$\lambda$和$\mu$是相等的：
$$
p^2-4q=0\Longrightarrow (\lambda+\mu)^2-4\lambda\mu=(\lambda-\mu)^2=0\Longrightarrow \lambda=\mu\tag{1.29}
$$
套一下我们先前的结果（式$(1.9)$），
$$
x=e^{\mu t}\int{e^{-\mu t}C_1e^{\lambda t}\mathrm dt}=e^{\lambda t}\int C_1\mathrm dt=(C_1x+C_2)e^{\lambda t}\tag{1.30}
$$
至此，我们完全解决了这样一类方程的求解问题！

## 从特殊到一般

emmm...或许我们可以更进一步，更高阶的情况，是不是也可以这样处理呢？先看我们的方程：
$$
a_0x+a_1x'+a_2x''+\cdots+a_nx^{(n)}=0\tag{1.31}
$$
先给大家五分钟回顾思考一下。

这时不同的人可能就会有不同的想法了（如果没有愣住的话）。

一些人可能会这样想，既然我们可以用移项把二阶方程转化成两个关于新函数的一阶方程，从而借助求解线性方程组得到答案，那么，我们是否能够通过移项，就像刚刚将二阶方程转换成两个一阶方程一样，把原来的一个$n$阶方程转化成$n$个一阶方程，再求解代数方程组得到结果呢？说干就干！

我们假设移项后能得到的方程形如
$$
\left(b_0x+b_1x'+b_2x''+\cdots b_{n-1}x^{(n-1)}\right)'=\alpha\left(b_0x+b_1x'+b_2x''+\cdots b_{n-1}x^{(n-1)}\right)\tag{1.32}
$$
为了直观起见，我们用求和符号重新表述方程的两个形式。
$$
\sum_{i=0}^n a_ix^{(i)}=0\tag{1.33}
$$

$$
\left(\sum_{i=0}^{n-1}b_{i}x^{(i)}\right)'=\alpha\sum_{i=0}^{n-1}b_ix^{(i)}\tag{1.34}
$$

我们考虑对形式略复杂的$(1.34)$式做整理，向$(1.33)$靠拢：
$$
\begin{eqnarray}
&\left(\sum_{i=0}^{n-1}b_{i}x^{(i)}\right)'=\alpha\sum_{i=0}^{n-1}b_ix^{(i)}\\
\Leftrightarrow&\sum_{i=0}^{n-1}b_{i}x^{(i+1)}=\alpha\sum_{i=0}^{n-1}b_ix^{(i)}\\
\Leftrightarrow&\sum_{i=1}^{n}b_{i-1}x^{(i)}=\alpha\sum_{i=0}^{n-1}b_ix^{(i)}\\
\Leftrightarrow&b_{n-1}x^{(n)}-\alpha b_0x+\sum_{i=1}^{n-1}\left(b_{i-1}-\alpha b_i\right)x^{(i)}=0\\
\end{eqnarray}\tag{1.35}
$$
因为$(1.35)$的最后一行和$(1.33)$实际上是同一个方程，通过对应项系数相等，我们有
$$
\begin{cases}
a_0=-\alpha b_0\\
a_i=b_{i-1}-\alpha b_i~(1\le i\le n-1)\\
a_n=b_{n-1}
\end{cases}\tag{1.36}
$$
emmm...乍看来似乎不是那么简单，但是，透过第二行的$a_i=b_{i-1}-\alpha b_i~(1\le i\le n-1)$可以看出，现在至少有一个关于$b_i$的递推公式给予我们一丝丝的曙光：
$$
b_{i-1}=\alpha b_i+a_i~(1\le i\le n-1)\tag{1.37}
$$
好吧，这个递推式是“反向”的，略有那么一点点反直观。虽然直接“反着”算也是可行的，但是我们在这里仍然尝试将其换成$b_i=f(b_{i-1})$的形式：
$$
b_i=\frac{b_{i-1}}\alpha-\frac{a_i}\alpha\tag{1.38}
$$
我们留意到，这里实际上假定了$\alpha\ne0$，那么我们该怎样证明这一假定的合理性呢？不妨先来看如果$\alpha=0$会怎样。这时，我们的方程就变成了
$$
\left(\sum_{i=0}^{n-1}b_{i}x^{(i)}\right)'=\alpha\sum_{i=0}^{n-1}b_ix^{(i)}=0\tag{1.39}
$$
即
$$
\sum_{i=0}^{n-1}b_{i}x^{(i+1)}=0\tag{1.40}
$$
考虑到对应系数相等，方程实际上为
$$
a_1x'+a_2x''+\cdots+a_nx^{(n)}=0\tag{1.41}
$$
注意到这时方程比起来原方程少了含原函数$x$的项（因为其系数为0）。不难看出，这实际上是关于$x'$的一个$(n-1)$阶方程。也就是说，如果真的存在一个$\alpha=0$，则原来的方程通过换元就可以“自动地”完成一次降阶操作，可以直接地视作$(n-1)$阶方程进行处理。

实际上，对于$\displaystyle\sum_{i=m}^na_ix^{(i)}=0$这类方程，我们可以取其最低阶的非零项对应的导数$x^{(m)}$作为新的主元$y$，得到新的、0阶项系数非零的$(n-m)$阶方程$\displaystyle\sum_{i=0}^{n-m}a_{i+m}y^{(i)}=0$，而这类方程对应的$\alpha$必然非零，可以延续以上方法求解。

回到主线。回想起数列递推公式与微分方程的那些个“暧昧”的关系（以后再提），我们不免将我们的递推公式$b_i=\frac1\alpha b_{i-1}+\frac{a_i}{\alpha}$（或者说$b_i-b_{i-1}=\frac{1-\alpha}{\alpha}b_{i-1}+\frac{a_i}\alpha$）与微分方程$b'(t)=\frac{1-\alpha}{\alpha} b(t)+a(t)$联系到一起。那么，这个递推公式确定的通项公式，是否与对应的微分方程的解$b(t)=\exp(\frac{1-\alpha}{\alpha}t)\displaystyle\int\exp(-\frac{1-\alpha}{\alpha}t)a(t)\mathrm dt$有相似的形式呢？

不失一般性，我们设一个数列$\{p_n\}$由以下递推公式确定（$k\ne0$）
$$
p_n=kp_{n-1}+q_i\tag{1.42}
$$
不妨猜测$p_n$具有指数函数与某数列和（因为求和与积分相对应）相乘的形式，而且指数部分的底数预计理应为$k$，即
$$
p_n=k^nP_n\tag{1.43}
$$
回代到原方程
$$
k^nP_n=k^nP_{n-1}+q_n\tag{1.44}
$$
注意到含$P_n$与$P_{n-1}$的项均具有因式$k^n$，于是上式又可化为
$$
P_n-P_{n-1}=k^{-n}q_n\tag{1.45}
$$
至此我们注意到$P_n$可由$k^{-n}q_n$累加得到。假设原递推公式对$n\ge1$皆成立，则有
$$
P_n=P_0+\sum_{i=1}^nk^{-i}q_i\tag{1.46}
$$
所以
$$
p_n=k^n\left(\sum_{i=1}^nk^{-i}q_i+P_0\right)\tag{1.47}
$$
可见$p_n$的通项与对应的微分方程的解$e^{kt}\displaystyle\int e^{-kt}q\mathrm dt$有极为相似的形式（表面上相差的$P_0$对应不定积分中由初值条件确定的积分常数）。

据以上结论，特定于对$b_i$​的递推公式，我们有
$$
b_i=\frac1{\alpha^i}\left(\sum_{j=1}^i\alpha^j\left(-\frac{a_j}{\alpha}\right)+b_0\right)\tag{1.48}
$$
前面经由系数相等我们得到了$b_0=-\frac{a_0}\alpha$，据此代换并整理后，上式实际上可以写成
$$
b_i=-\sum_{j=0}^i\alpha^{j-i-1}a_j\tag{1.49}
$$
以此可得
$$
a_n=b_{n-1}=-\sum_{j=0}^{n-1}\alpha^{j-n}a_j\tag{1.50}
$$
两端同乘以$\alpha^n$后移项有
$$
\sum_{j=0}^na_j\alpha^j=0\tag{1.51}
$$
这是一个关于$\alpha$的$n$次多项式方程。到了这一步，我们其实证明了移项后的方程中的$\alpha$就是微分方程的特征方程的根。

一般情况下，特征方程最可能会有$n$个相异的实根，这时我们可以给出$\alpha$的$n$个不同的取值，继而可以由$n$种不同的移项方法得到$n$个不同的方程，解得$n$个不同的解。而这些解都具有形式
$$
\sum_{i=0}^{n-1}b_{i}x^{(i)}=Ce^{\alpha t}\tag{1.52}
$$
将它们编号、联立
$$
\begin{cases}\begin{matrix}
\sum_{i=0}^{n-1}b_{1,i}x^{(i)}=C_1e^{\alpha_1 t}\\
\sum_{i=0}^{n-1}b_{2,i}x^{(i)}=C_2e^{\alpha_2 t}\\
\vdots\\
\sum_{i=0}^{n-1}b_{n,i}x^{(i)}=C_ne^{\alpha_3 t}\\
\end{matrix}\end{cases}\tag{1.53}
$$
这构成了关于$x$、$x'$、$\cdots$、$x^{(n-1)}$的线性方程组。只要行列式$|b_{j,i-1}|\ne0$，我们就可以解得原函数$x$。很容易证明，$x$具有以下形式
$$
x=\sum_{i=1}^n D_ie^{\alpha_it}\tag{1.54}
$$
其中$D_i$这一系列常数由初值条件决定。

至此，我们证明了最大概率出现的“一般情形”下线性微分方程的特征根解法的合理性。

可能会问了，疑，不对呀，$\alpha$是虚数时$x$的解析式当中会出现三角函数项呀。其实，我们可以借助欧拉公式$e^{ix}=\cos x+i\sin x$将上面的形式中出现的“成对”（共轭）的复指数项转化为含三角函数的项。点到为止，此处暂不细究。

## Corner Cases

到这里总结一下，我们对高阶方程还有两处遗留问题。第一，如果特征方程存在重根，我们应如何计算呢？第二，行列式$|b_{j,i-1}|\ne0$是否总是成立呢，或者，她不成立意味着什么呢？

暂且不作回答，让我们把目光转回到$b_i$。虽然我们理论上可以在得到$\alpha$后借助递推公式暴算出$b_i$，但这样做，似乎既繁琐，也不够优雅。

那么$b_i$的实质究竟是什么呢，难道……是其它的特征根吗？

我们假设一个微分方程的特征方程为
$$
(r-1)(r-2)(r-3)=(r-1)(r^2-5r+6)=r^3-6r^2+11r-6=0\tag{1.55}
$$
易知三个特征根分别为1、2、3。为方便计算，这里我们取$\alpha=1$，可以得到，$b_0=6$、$b_1=-5$、$b_2=1$，显然地，$b_i$并不是特征方程的根。

但是，神奇的事情发生了，$b_2x^2+b_1x+b_0$恰好是原方程的一个因式$r^2-5r+6$，而且这个因式恰好是从原方程中提取去我们选做$\alpha$的特征根$r=1$对应的因式$(r-1)$之后得到的。对其他根进行验证，发现原结论仍成立。我们该怎样证明这一结论呢？

首先，我们需要准确地表述我们的结论：

任取特征方程的一个根$\alpha$，则特征方程
$$
a_0+a_1r+a_2r^2+\cdots+a_nr^n=0\tag{1.56}
$$
可以表示为
$$
(r-\alpha)\left(b_0+b_1r+b_2r^2+\cdots+b_{n-1}r^{n-1}\right)=0\tag{1.57}
$$
其中$b_i$满足前面得到的关系式$(1.36)$。

对上式展开后，我们很容易地就证明了该结论。
$$
\begin{eqnarray}
(r-\alpha)\sum_{i=0}^{n-1}b_ir^i&=&\sum_{r=1}^nb_{i-1}r^{i}-\alpha\sum_{i=0}^{n-1}b_ir^i\\
&=&b_{n-1}r^n-\alpha b_0+\sum_{i=1}^{n-1}\left(b_{i-1}-\alpha b_i\right)r^i\\
&=&a_nr^n+a_0+\sum_{i=1}^{n-1}a_ir^i\\
&=&\sum_{i=0}^na_ir^i=0
\end{eqnarray}\tag{1.58}
$$
> 第一步，简单展开；第二步，尽可能多地配凑出递推式$a_i=b_{i-1}-\alpha b_i$的形式；第三步，按$(1.36)$做代换；第四步，整理得证

这也就意味着，方程$b_0+b_1r+b_2r^2+\cdots+b_{n-1}r^{n-1}=0$的根恰好为原特征方程中未被选为$\alpha$的那些根。

还记得这个方程吗？
$$
\sum_{i=0}^{n-1}b_{i}x^{(i)}=Ce^{\alpha t}\tag{1.59}
$$
这是我们对原方程移项降阶得到的新方程的解。同样地，对这个方程我们还可以继续移项：
$$
\left(\sum_{i=0}^{n-2}c_ix^{(i)}\right)'=\beta\sum_{i=0}^{n-2}c_ix^{(i)}+Ce^{\alpha t}\tag{1.60}
$$
> 当然，这一思路也可能是部分读者在那五分钟的“回顾思考”中就已经想到的，尽管关于$b_i$性质的结论可能没有被注意到。

因为$(1.59)$的特征方程就是$b_0+b_1r+b_2r^2+\cdots+b_{n-1}r^{n-1}=0$，而她的根恰好为原特征方程中未被选为$\alpha$的那些根，所以$\beta$可以从选取$\alpha$​时“选剩下”的那些根里边选取。

此时可以解得
$$
\sum_{i=0}^{n-2}c_ix^{(i)}=e^{\beta t}\int e^{-\beta t}Ce^{\alpha t} \mathrm dt\tag{1.61}
$$
为方便叙述，这里我们不妨将原方程的特征根设为$\alpha_1$、$\alpha_2$、$\cdots$、$\alpha_n$​​，反复进行上面的移项降阶与求解的操作，我们可以得到
$$
x=e^{\alpha_nt}\left(\int e^{-\alpha_nt}e^{\alpha_{n-1}t}\left(\int e^{-\alpha_{n-1}t}e^{\alpha_{n-2}t}\left(\int\cdots\left(\int e^{-\alpha_2t}Ce^{\alpha_1t}\mathrm dt\right)\cdots \right)\mathrm dt\right)\mathrm dt\right)\tag{1.62}
$$
或者完整点来说是
$$
x=e^{\alpha_nt}\left(\int e^{-\alpha_nt}e^{\alpha_{n-1}t}\left(\int e^{-\alpha_{n-1}t}e^{\alpha_{n-2}t}\left(\int\cdots\left(\int e^{-\alpha_2t}e^{\alpha_1t}\left(\int e^{-\alpha_1t}\cdot0\mathrm dt\right)\mathrm dt\right)\cdots \right)\mathrm dt\right)\mathrm dt\right)\tag{1.63}
$$
也可以写成“反向”递推形式
$$
X_{n-i}=e^{\alpha_it}\int e^{-\alpha_it}X_{n-i+1}\mathrm dt\tag{1.64}
$$

$$
X_n=\sum_{i=1}^na_ix^{(i)}=0\tag{1.65}
$$

其中$X_k$为$x$、$x'$、$x''$、$\cdots$、$x^{(k)}$​的线性组合，而根据积分号的嵌套层数，又可知$X_0=x$。

这里我们试着以这一思路求解原方程。首先尝试利用归纳法证明，特征根互异时，$X_{n-i}$具有与原方程的解类似的形式，即
$$
X_{n-i}=\sum_{j=1}^iC_je^{\alpha_jt}\tag{1.66}
$$
显然地，该结论对$i=0$成立（系数$c_j$恒为0）。我们尝试将上式带入递推公式$(1.64)$，假设$a_i\ne a_{i+1}$，得到

> 如有兴趣，这里，还有以下的一些较复杂积分可以自行计算，以验证原结论

$$
\begin{eqnarray}
X_{n-i-1}&=&e^{\alpha_{i+1}t}\int e^{-\alpha_{i+1}t}\sum_{j=1}^iC_je^{\alpha_jt}\mathrm dt\\
&=&e^{\alpha_{i+1}t}\left(C+\sum_{j=1}^i\frac{C_je^{(\alpha_j-\alpha_{i+1})t}}{\alpha_j-\alpha_{i+1}}\right)\\
&=&Ce^{\alpha_{i+1}t}+\sum_{j=1}^i\frac{C_je^{\alpha_jt}}{\alpha_j-\alpha_{i+1}}
\end{eqnarray}\tag{1.67}
$$
式中$C_1$到$C_i$的系数均为可以任意取值的常数。由数学归纳法，易知原命题得证。

再来看存在重根的情形。不失一般性，我们假设$\alpha_{k}=\alpha_{k+1}=\alpha_{k+2}=\cdots=\alpha_{k+l}$，而且$1\le i\le k$时$\alpha_i$互不相等，我们设$X_{n-k}=\sum_{i=1}^kC_ie^{\alpha_it}$，则有
$$
\begin{eqnarray}
X_{n-k-1}&=&e^{\alpha_{k+1}t}\int e^{-\alpha_{k+1}t}\sum_{j=1}^iC_je^{\alpha_jt}\mathrm dt\\
&=&e^{\alpha_{k}t}\left(C+\sum_{j=1}^{k-1}\frac{C_je^{(\alpha_j-\alpha_{k})t}}{\alpha_j-\alpha_{k+1}}+\int{C_ke^{0}\mathrm dt}\right)\\
&=&(C_kt+C+C')e^{\alpha_{k}t}+\sum_{j=1}^{k-1}\frac{C_je^{\alpha_jt}}{\alpha_j-\alpha_{k+1}}
\end{eqnarray}\tag{1.68}
$$
> 其实到了这一步，特征方程重根在通解中产生多项式的原因就初现端倪了：积分内的因子$e^{-\alpha_{k+1}t}$与既有的$e^{\alpha_{k+1}t}$项相乘后被“抵消”为常数，产生常数又被积分，继而产生多项式。

我们注意到，代入递推公式$(1.64)$再一轮积分以后，重根对应的项多了一个因式$C_kt+C+C'$，那么，如果我们再做一轮积分又会如何呢？
$$
\begin{eqnarray}
X_{n-k-2}&=&e^{\alpha_{k+2}t}\int e^{-\alpha_{k+2}t}\left((C_jt+C+C')e^{\alpha_{k+1}t}+\sum_{j=1}^{k-1}\frac{C_je^{\alpha_jt}}{\alpha_j-\alpha_{k+1}}\right)\mathrm dt\\
&=&e^{\alpha_{k+2}t}\int\left((C_jt+C+C')+\sum_{j=1}^{k-1}\frac{C_je^{(\alpha_j-\alpha_{k+2}t)t}}{\alpha_j-\alpha_{k+1}}\right)\mathrm dt\\
&=&\left(\frac{C_k}{2}t^2+(C+C')t+C''\right)e^{\alpha_{k}t}+\sum_{i=1}^{k-1}\frac{C_je^{\alpha_jt}}{(\alpha_j-\alpha_{k+1})(a_j-\alpha_{k+2})}
\end{eqnarray}\tag{1.69}
$$
这时，重根对应的项前边出现的一次因式变成了二次因式。于是我们猜测，这样累次积分的过程中，$(l+1)$重根最终会产生一个形如$l$次多项式与指数函数乘积的项，即$X_{n-k-l}$应该具有以下形式
$$
X_{n-k-l}=e^{\alpha_kt}\sum_{i=0}^{l}D_{i}t^i+\sum_{i=1}^{k-1}E_ie^{\alpha_it}\tag{1.70}
$$
其中，$D_i$、$E_i$​均为常数。

依然尝试借助归纳法证明。我们假设
$$
X_{n-k-j}=e^{\alpha_kt}\sum_{i=0}^{j}D_{j,i}t^i+\sum_{i=1}^{k-1}E_{j,i}e^{\alpha_it}\tag{1.71}
$$
其中，$D_{j,i}$、$E_{j,i}$均为常数，且为了使下一轮积分中用到的$\alpha_{k+j+1}$仍在同一组重根当中，应有$0\le j\le l-1$。不难得知，这一等式在$l=0,1,2$时都是成立的。我们将其代入递推公式进行一轮积分
$$
\begin{eqnarray}
X_{n-k-(j+1)}&=&e^{\alpha_{k+j+1}t}\int e^{-\alpha_{k+j+1}t}X_{n-k-j}\mathrm dt\\
&=&e^{\alpha_{k+j+1}t}\int e^{-\alpha_{k+j+1}t}\left(e^{\alpha_kt}\sum_{i=0}^{j}D_{j,i}t^i+\sum_{i=1}^{k-1}E_{j,i}e^{\alpha_it}\right)\mathrm dt\\
&=&e^{\alpha_{k}t}\int e^{-\alpha_{k}t}\left(e^{\alpha_kt}\sum_{i=0}^{j}D_{j,i}t^i+\sum_{i=1}^{k-1}E_{j,i}e^{\alpha_it}\right)\mathrm dt\\
&=&e^{\alpha_{k}t}\int\left(\sum_{i=0}^{j}D_{j,i}t^i+\sum_{i=1}^{k-1}E_{j,i}e^{(\alpha_i-\alpha_k)t}\right)\mathrm dt\\
&=&e^{\alpha_{k}t}\left(\sum_{i=0}^j\frac{D_{j,i}}{i+1}t^{i+1}+D_{j+1,0}\right)+\sum_{i=1}^{k-1}\frac{E_{j,i}e^{\alpha_it}}{\alpha_i-\alpha_k}
\end{eqnarray}\tag{1.72}
$$
可以留意到，$X_{n-k-(j+1)}$仍具有$(1.71)$式的形式，故可推知，$X_{n-k-j}$在$0\le j\le l$使均有该式的形式。原假设得证。

由于$\alpha_i$的排序是任意的，我们可以将唯一一组重根连续地放在下标最大的位置，使涉及重根的递推步骤在最后进行。继而易知，$X_0$也应具有上式的形式。而$X_0$与原函数$x$仅差了一个常系数，而且$X_0$的表达式中各项也都拥有由初值条件确定的待定常系数，$x$的形式与$X_0$​的形式理应一致。至此，我们实际上确定了特征方程只存在一组重根时方程解的形式。

对于特征方程存在多组重根的情形，我们可以把$E_{j,i}e^{\alpha_it}$这样只含常数与指数因子而不含多项式因式的项看作0次多项式与指数函数的乘积，以此可不失一般性地猜测式$X_k$的形式的另一种表示可以为
$$
X_{n-k}=\sum_{i=1}^me^{\beta_it}\sum_{j=0}^{p_i}C_{i,j}t^j\tag{1.73}
$$
式中$C_{i,j}$为常数。同时，$\beta_1$到$\beta_m$由$\alpha_1$到$\alpha_k$中出现的所有相异特征根组成，$p_i$为$\beta_i$对应值在$\alpha_1$到$\alpha_k$中出现的次数（亦为其重数），即我们假定：
$$
\prod_{i=1}^{m}(x-\beta_i)^{p_i}=\prod_{i=1}^k(x-\alpha_i)\tag{1.74}
$$
将$(1.73)$代入递推公式$(1.64)$
$$
X_{n-k-1}=e^{\alpha_{k+1}t}\int e^{-\alpha_{k+1}t}\sum_{i=1}^me^{\beta_it}\sum_{j=0}^{p_i}C_{i,j}t^j\mathrm dt\tag{1.75}
$$
假设$\alpha_{k+1}$与$\beta_1$到$\beta_m$均不相等，则$\alpha_{k+1}$的值在$\alpha_1$到$\alpha_k$中没有出现过，此时有
$$
\begin{eqnarray}
X_{n-k-1}&=&e^{\alpha_{k+1}t}\int e^{-\alpha_{k+1}t}\sum_{i=1}^me^{\beta_it}\sum_{j=0}^{p_i}C_{i,j}t^j\mathrm dt\\
&=&\sum_{i=1}^me^{\alpha_{k+1}t}\int e^{(\beta_i-\alpha_{k+1})t}\sum_{j=0}^{p_i}C_{i,j}t^j\mathrm dt
\end{eqnarray}\tag{1.76}
$$
这里出现了指数函数与高次多项式乘积的积分，我们先在此专门对这一问题进行一点研究。

经常做不定积分习题的都知道，不考虑积分常数时，指数函数与一次函数的乘积在积分后仍然是指数函数与一次函数的乘积，指数函数与二次函数的乘积在积分后仍然是指数函数与二次函数的乘积，那么，我们能否将这一规律推广到指数函数与更高次的多项式相乘的情形呢？还是先试着用归纳法证明。通过计算容易验证，上述结论对0、1、2次多项式的情形均成立。

借助分部积分
$$
\begin{eqnarray}
\int e^{ct}\sum_{i=0}^na_it^i\mathrm dt&=&\frac1ce^{ct}\sum_{i=0}^na_it^i-\int\frac1ce^{ct}\sum_{i=0}^{n-1}(i+1)a_{i+1}t^i\mathrm dt\\
\end{eqnarray}\tag{1.77}
$$
这样，我们得知，$n$次多项式与指数函数的乘积的积分可以被表示为原指数函数与另一个$n$次多项式的乘积与原指数函数与$(n-1)$次多项式乘积的积分两项的和。到这里，我们在某种意义上对被积函数中的多项式完成了一次“降次”的操作，那么，我们是否可以像计算二次多项式与指数函数的乘积一样，通过多次的降次得到最终结果呢？

假设原结论在被积函数中多项式为$(n-1)$次时成立，则上面的积分实际上可以表示为
$$
\int e^{ct}\sum_{i=0}^na_it^i\mathrm dt=\frac1ce^{ct}\sum_{i=0}^n a_it^i-\frac1ce^{ct}\sum_{i=0}^{n-1}b_it^i+C=e^{ct}\left(\frac{a_n}{c}t^n+\sum_{i=0}^{n-1}\frac{a_i-b_i}ct^i\right)+C\tag{1.78}
$$
因为$a_n\ne0$，显然地，上式的右半部分为原指数函数与$n$次多项式的乘积。这实际上意味着，原结论在被积函数多项式部分为$(n-1)$次时若成立，则它在相应多项式为$n$次时亦成立。综上，由数学归纳法，原命题得证，即形式上有以下结论成立：
$$
\int e^{ct}\sum_{i=0}^na_it^i\mathrm dt=e^{ct}\sum_{i=0}^nc_it^i+C\tag{1.79}
$$
借助上述结论，我们可以对式$(1.76)$进行一点化简
$$
X_{n-k-1}=\sum_{i=1}^me^{\alpha_{k+1}t}\left(e^{(\beta_i-\alpha_{k+1})t}\sum_{j=1}^{p_i}D_{i,j}t^j+C_i\right)=\sum_{i=1}^me^{\beta_it}\sum_{j=1}^{p_i}D_{i,j}t^j+e^{\alpha_{k+1}t}\sum_{i=1}^mC_i\tag{1.80}
$$
这意味着，当$\alpha_{k+1}$在$\alpha_1$到$\alpha_{k}$中没有出现过时，$X_{n-k-1}$由一个与$X_{n-k}$形式相同的式子与一个带有常系数且指数为$\alpha_{k+1}$的指数项相加组成。换句话说，$X_{n-k-1}$较$X_{n-k}$增加了一个新的指数项。

再来讨论另一种情形，这时我们假设$\alpha_{k+1}$在$\alpha_1$到$\alpha_k$中出现过，则应存在唯一的$\beta_q=\alpha_{k+1}$。此时$(1.76)$可化为
$$
\begin{eqnarray}
X_{n-k-1}&=&e^{\alpha_{k+1}t}\int e^{-\alpha_{k+1}t}\sum_{i=1}^me^{\beta_it}\sum_{j=0}^{p_i}C_{i,j}t^j\mathrm dt\\
&=&\sum_{\begin{matrix}1\le i\le m\\i\ne q\end{matrix}}^{}e^{\alpha_{k+1}t}\int e^{(\beta_i-\alpha_{k+1})t}\sum_{j=0}^{p_i}C_{i,j}t^j\mathrm dt+e^{\alpha_{k+1}t}\int e^{(\beta_q-\alpha_{k+1})t}\sum_{j=0}^{p_q}C_{q,j}t^j\mathrm dt\\
&=&\sum_{\begin{matrix}1\le i\le m\\i\ne q\end{matrix}}e^{\alpha_{k+1}t}\int e^{(\beta_i-\alpha_{k+1})t}\sum_{j=0}^{p_i}C_{i,j}t^j\mathrm dt+e^{\alpha_{k+1}t}\int\sum_{j=0}^{p_q}C_{q,j}t^j\mathrm dt
\end{eqnarray}\tag{1.81}
$$
对上式最后一行的前半部分运用上一种情形中得到的结论，并计算后半部分中的积分
$$
\begin{eqnarray}
X_{n-k-1}&=&\sum_{\begin{matrix}1\le i\le m\\i\ne q\end{matrix}}e^{\alpha_{k+1}t}\left(e^{(\beta_i-\alpha_{k+1})t}\sum_{j=0}^{p_i}D_{i,j}t^j+C_i\right)+e^{\alpha_{k+1}t}\sum_{j=0}^{p_q}\frac{C_{q,j}}{j+1}t^{j+1}\\
&=&\sum_{\begin{matrix}1\le i\le m\\i\ne q\end{matrix}}e^{\beta_it}\sum_{j=0}^{p_i}D_{i,j}t^j+e^{\alpha_{k+1}t}\left(\sum_{j=0}^{p_q}\frac{C_{q,j}}{j+1}t^{j+1}+\sum_{\begin{matrix}1\le i\le m\\i\ne q\end{matrix}}C_i+C\right)
\end{eqnarray}\tag{1.82}
$$
注意到这里含$e^{\beta_qt}$的项的次数增加到了$(n+1)$。可知，相较于$X_{n-k}$，上式中$i\ne q$时含$e^{\beta_it}$的项形式不变，而含$e^{\beta_qt}$的项中的多项式的次数会增加1。

考虑到$k$选取的任意性，综合两种情形，可以从直观的角度得到如下结论：

称$X_{n-k-1}$为$X_{n-k}$对应的“下一个”中间函数，由一个中间函数得到其下一个中间函数的过程称为“一轮运算”，一轮运算当中的用到的特征根（上面的例子中是$\alpha_{k+1}$）为“当前特征根”。则：

- 若当前特征根在此前的各轮运算中均未出现，则下一个中间函数会比原先的中间函数增加一个由常系数和以当前特征根为指数位置系数的指数项相乘得到的项。
- 若当前特征根在此前的各轮运算中出现过，则下一个中间函数中包含此特征根的项当中的多项式次数会增加1（常系数视为0次多项式）。

这样我们便以一种“程序化”的角度描述了特征根对$X_i$的影响。

由$X_n=0$得到$X_0$的过程中，我们会用到全部的$n$个特征根。这样，$p$重根恰好会在运算中出现$p$次，含该根对应的指数项的项当中的多项式恰好为$(p-1)$次。假设原特征方程存在$s$个互异的根，第$i$个根$\beta_i$的重数为$p_i$，则$X_0$形式如下：
$$
X_0=\sum_{i=1}^se^{\beta_it}\sum_{j=0}^{p_i}c_{i,j}t^j\tag{1.83}
$$
因为$X_0$与原方程的解只相差一个由初值条件确定的常系数，原方程的解也应有上述形式
$$
x=\sum_{i=1}^se^{\beta_it}\sum_{j=0}^{p_i}c_{i,j}t^j\tag{1.84}
$$
不难看出，$c_{i,j}$共有$n$个，这可由$n$组初值条件组成方程组求解。

至此，我们解决了特征方程拥有重根时相应微分方程的求解问题。

## 余音

再看一下最后一点遗留的问题，即行列式$D=|b_{j,i-1}|=0$在何时成立、意味着什么。因为这一行列式有$n^2$个元素，而确定该行列式只需要特征方程中的$n+1$个系数，所以，该行列式并不是那样被随意地给出的，而且还可以感性地判断，该行列式的值与特征方程应有密切的联系。

先来展开写出上面的行列式：
$$
\begin{eqnarray}
D&=&\left|
\begin{matrix}
	b_{1,0}&b_{1,1}&\cdots&b_{1,n-1}\\
	b_{2,0}&b_{2,1}&\cdots&b_{2,n-1}\\
	\vdots&\vdots&&\vdots\\
	b_{n,0}&b_{n,1}&\cdots&b_{n,n-1}\\
\end{matrix}
\right|\\\\
&=&\left|
\begin{matrix}
	-\sum_{j=0}^0\alpha_1^{j-1}a_j&-\sum_{j=0}^1\alpha_1^{j-2}a_j&\cdots&-\sum_{j=0}^{n-1}\alpha_1^{j-n}a_j\\
	-\sum_{j=0}^0\alpha_2^{j-1}a_j&-\sum_{j=0}^1\alpha_2^{j-2}a_j&\cdots&-\sum_{j=0}^{n-1}\alpha_2^{j-n}a_j\\
	\vdots&\vdots&&\vdots\\
	-\sum_{j=0}^0\alpha_n^{j-1}a_j&-\sum_{j=0}^1\alpha_n^{j-2}a_j&\cdots&-\sum_{j=0}^{n-1}\alpha_n^{j-n}a_j
\end{matrix}
\right|\\\\
&=&(-1)^n\left|
\begin{matrix}
	\sum_{j=0}^0\alpha_1^{j-1}a_j&\sum_{j=0}^1\alpha_1^{j-2}a_j&\cdots&\sum_{j=0}^{n-1}\alpha_1^{j-n}a_j\\
	\sum_{j=0}^0\alpha_2^{j-1}a_j&\sum_{j=0}^1\alpha_2^{j-2}a_j&\cdots&\sum_{j=0}^{n-1}\alpha_2^{j-n}a_j\\
	\vdots&\vdots&&\vdots\\
	\sum_{j=0}^0\alpha_n^{j-1}a_j&\sum_{j=0}^1\alpha_n^{j-2}a_j&\cdots&\sum_{j=0}^{n-1}\alpha_n^{j-n}a_j
\end{matrix}
\right|
\end{eqnarray}\tag{1.85}
$$

由此我们不难注意到，若方程存在重根，原行列式就会拥有完全相等的两行，值为0。反过来这一结论是否成立呢？为证明这一结论，我们不妨假设$D=0$时原方程不存在重根。在上边的研究中，我们注意到，$b_{j,i-1}$实际上就是原方程的特征方程在除去一个因式后得到的多项式当中各项的系数。不妨设
$$
P=a_n\prod_{i=1}^n(\alpha-\alpha_i)\tag{1.86}
$$

$$
P_i=a_n\prod_{\begin{matrix}1\le j\le n\\j\ne i\end{matrix}}(\alpha-\alpha_{j})=\sum_{j=0}^{n-1}b_{i,j}\alpha^j\tag{1.87}
$$

鉴于$P_i$“自然地”形成了一个组，我们试着将它们包含在同一个矩阵当中
$$
\boldsymbol M=\left(\begin{matrix}
P_1\\P_2\\\vdots\\P_n
\end{matrix}\right)\tag{1.88}
$$
这里用到了矩阵这一工具，那么不妨使用矩阵乘法将上式与行列式$D$联系起来。设$D$对应的矩阵为$\boldsymbol D_M$，此时注意到
$$
\boldsymbol D_M\left(\begin{matrix}\alpha^0\\\alpha_1\\\vdots\\\alpha^{n-1}\end{matrix}\right)=\boldsymbol M\tag{1.89}
$$
或简写为
$$
\boldsymbol D_M\boldsymbol A=\boldsymbol M\tag{1.90}
$$
比起描述逐个元素的式$(1.85)$，该式显得更为紧凑。但是，单从此式我们并不能直接提取出行列式$D$这一项：因为$\boldsymbol A$与$\boldsymbol M$不是方阵，由此得到的等式$|\boldsymbol D_M||\boldsymbol A|=D|\boldsymbol A|=|\boldsymbol M|$是没有意义的。为弥补这一缺陷，我们试着将$\boldsymbol A$拓展成一个方阵$\boldsymbol A_E$。经过尝试不难发现，补入全零行等很多简单的操作既对接下来的证明没有帮助，也破坏了原式的对称性，更没有建立起$D$与特征根$\alpha_i$的联系。最终，我们选择将$A$中$\alpha$替换成特征根的每一个取值，每个根对应的替换置入新矩阵$\boldsymbol A_E$的相应列当中。由此得到
$$
\boldsymbol A_E=\left(\begin{matrix}
\alpha_1^0&\alpha_2^0&\cdots&\alpha_n^0\\
\alpha_1^1&\alpha_2^1&\cdots&\alpha_n^1\\
\vdots&\vdots&&\vdots\\
\alpha_1^{n-1}&\alpha_2^{n-1}&\cdots&\alpha_n^{n-1}\\
\end{matrix}\right)\tag{1.91}
$$
我们设
$$
\boldsymbol F=(f_{i,j})=\boldsymbol D_M\boldsymbol A_E\tag{1.92}
$$
考虑到$P_i$是原特征方程多项式去除$(\alpha-\alpha_i)$这一因式后得到的，那么我们得知，$P_i=0$的根是从原方程的特征根即$P=0$的根中去掉一个$\alpha_i$得到的。若$\alpha_i$是重根，则去掉这样一个根后，$\alpha_i$仍将是$P_i=0$的根；否则，$\alpha_i$将不再是$P_i=0$的根。换言之，将$\alpha=\alpha_i$代入$P_i$，当且仅当$\alpha_i$是原特征方程的重根时，有$P_i=0$成立。

展开$\boldsymbol F$的元素$f_{i,j}$的如下
$$
f_{i,j}=\sum_{k=0}^{n-1}b_{i,k}\alpha_j^k=P_i|_{\alpha=\alpha_j}\tag{1.93}
$$
由于此处我们假定了特征方程没有重根，所以$\alpha_i$一定不是$P_i=0$的根，$P_i|_{\alpha=\alpha_i}$的值一定非零。

同时，我们考虑到$i\ne j$时，$P_i$中的因式$(\alpha-\alpha_j)$并没有被除去，$P_i=0$仍包含根$\alpha_j$，故$P_i|_{\alpha=\alpha_j}$的值一定为0。

综上，用$N$标记非零值（不指代任何具体值），可以写出$F$形式如下
$$
\boldsymbol D_M\boldsymbol A_E=\boldsymbol F=\left(\begin{matrix}
N&0&0&\cdots&0\\
0&N&0&\cdots&0\\
0&0&N&\cdots&0\\
\vdots&\vdots&\vdots&&\vdots\\
0&0&0&\cdots&N\\
\end{matrix}\right)\tag{1.94}
$$
这是一个简单的对角矩阵，因为其主对角线上元素均非零，其所对应的行列式也非零，由上式可得
$$
|\boldsymbol D_M||\boldsymbol A_E|=|\boldsymbol F|\ne0\tag{1.95}
$$
但是，我们有前提$D=|\boldsymbol D_M|=0$，所以有$|F|=D|\boldsymbol A_E|=0$，与上式出现矛盾，故特征方程不存在重根的假设不成立，所以原特征方程存在重根。

进而，我们证明了，不考虑特征根可以取0的情形（受$b_{j,i-1}$定义的限制），$D=0$与原特征方程存在重根等价。

这实际上也说明了我们前边借助线性方程组求解原方程时假定$D\ne0$的合理性，因为那时我们的方法只有在原特征方程无重根时才能得到足够多的方程来联立求出唯一解，而此恰好为$D\ne0$成立的条件。

## 未完待续

在下一节，我们会将目光转移到另一个推广方向上，一个同样以平淡无奇的情景开始，又同样以对corner cases的繁杂论述结束的方向。但相比于这次，在下次的旅程中，我们会更加接近推演的“深水区”。
